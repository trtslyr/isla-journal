name: Build Windows from Source

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Don't use npm cache to avoid lockfile conflicts
      
      - name: Setup Windows Build Environment
        run: |
          Write-Host "Setting up Windows build environment for native modules..."
          Write-Host "Node version: $(node --version)"
          Write-Host "NPM version: $(npm --version)"
          Write-Host "Platform: $env:OS"
          Write-Host "Architecture: $env:PROCESSOR_ARCHITECTURE"
        shell: powershell
      
      - name: Clean Environment (Remove any artifacts)
        run: |
          Write-Host "Ensuring completely clean build environment..."
          if (Test-Path "dist") { Remove-Item -Path "dist" -Recurse -Force }
          if (Test-Path "out") { Remove-Item -Path "out" -Recurse -Force }
          if (Test-Path "node_modules") { Remove-Item -Path "node_modules" -Recurse -Force }
          if (Test-Path "package-lock.json") { Remove-Item -Path "package-lock.json" -Force }
          if (Test-Path ".npm") { Remove-Item -Path ".npm" -Recurse -Force }
          Write-Host "Environment completely cleaned"
        shell: powershell
      
      - name: Fresh Install Dependencies
        run: |
          Write-Host "Installing dependencies with clean postinstall..."
          Write-Host "Generating fresh package-lock.json..."
          npm install --package-lock-only
          Write-Host "Installing with fresh lockfile (build from source)..."
          # Force npm to build from source
          $env:npm_config_build_from_source = "true"
          $env:npm_config_cache = ""
          npm ci
          Write-Host "Dependencies installed successfully"
        shell: powershell
      
      - name: Rebuild Native Modules for Windows
        run: |
          Write-Host "Building native modules from source for Windows..."
          
          # Ensure we're building for the correct platform and architecture
          $env:npm_config_target_platform = "win32"
          $env:npm_config_target_arch = "x64"  
          $env:npm_config_build_from_source = "true"
          $env:npm_config_sqlite3_binary_host_mirror = ""
          $env:npm_config_electron_cache = ""
          
          Write-Host "Platform: win32, Architecture: x64"
          Write-Host "Force building better-sqlite3 from source..."
          npm rebuild better-sqlite3 --build-from-source --verbose
          
          Write-Host "Building systeminformation from source..."
          npm rebuild systeminformation --verbose
          
          Write-Host "Running @electron/rebuild for all modules..."
          npx @electron/rebuild --verbose --force --arch=x64
          
          Write-Host "Native modules built successfully"
        shell: powershell
      
      - name: Verify Native Modules
        run: |
          Write-Host "Verifying native module binaries for Windows x64..."
          
          # Check better-sqlite3
          if (Test-Path "node_modules\better-sqlite3\build\Release\better_sqlite3.node") {
            Write-Host "SUCCESS: better-sqlite3 binary exists"
            $size = (Get-Item "node_modules\better-sqlite3\build\Release\better_sqlite3.node").Length
            Write-Host "   Size: $size bytes"
            
            # Verify it's a Windows binary (PE format)
            $fileBytes = [System.IO.File]::ReadAllBytes("node_modules\better-sqlite3\build\Release\better_sqlite3.node")
            if ($fileBytes[0] -eq 0x4D -and $fileBytes[1] -eq 0x5A) {
              Write-Host "   VERIFIED: Windows PE executable format"
            } else {
              Write-Host "   ERROR: Not a Windows binary! May contain Mac artifacts"
              exit 1
            }
          } else {
            Write-Host "ERROR: better-sqlite3 binary missing"
            # List what's actually in the build directory
            if (Test-Path "node_modules\better-sqlite3\build") {
              Write-Host "Build directory contents:"
              Get-ChildItem "node_modules\better-sqlite3\build" -Recurse
            }
            exit 1
          }
          
          # Check systeminformation
          if (Test-Path "node_modules\systeminformation\lib") {
            Write-Host "SUCCESS: systeminformation module exists"
          } else {
            Write-Host "ERROR: systeminformation module missing"
            exit 1
          }
          
          # Test loading the modules on Windows
          Write-Host "Testing module loading on Windows..."
          node -e "
            try {
              const Database = require('better-sqlite3');
              console.log('SUCCESS: better-sqlite3 loads successfully on Windows');
              const si = require('systeminformation');
              console.log('SUCCESS: systeminformation loads successfully on Windows');
            } catch (error) {
              console.error('ERROR: Module loading failed on Windows:', error.message);
              process.exit(1);
            }
          "
        shell: powershell
      
      - name: Build Application from Source
        run: |
          Write-Host "Building application completely from source..."
          
          # Clean any existing build artifacts first
          if (Test-Path "dist") { Remove-Item -Path "dist" -Recurse -Force }
          
          Write-Host "Building Vite frontend for Windows..."
          Write-Host "Current directory: $(pwd)"
          Write-Host "Checking if src/renderer exists..."
          if (Test-Path "src\renderer") {
            Write-Host "SUCCESS: src\renderer directory exists"
            Get-ChildItem "src\renderer" -Name
          } else {
            Write-Host "ERROR: src\renderer directory missing"
            exit 1
          }
          
          Write-Host "Running Vite build with error handling..."
          try {
            npm run build:vite
            if ($LASTEXITCODE -ne 0) {
              Write-Host "ERROR: Vite build failed with exit code $LASTEXITCODE"
              exit 1
            }
            Write-Host "SUCCESS: Vite build completed"
          } catch {
            Write-Host "ERROR: Vite build failed with exception: $_"
            exit 1
          }
          
          # Verify Vite build output before continuing
          Write-Host "Checking Vite build output..."
          if (Test-Path "dist\renderer") {
            Write-Host "SUCCESS: dist\renderer directory exists"
            $rendererFiles = Get-ChildItem "dist\renderer" -Recurse -File
            Write-Host "   Files created: $($rendererFiles.Count)"
            $rendererFiles | ForEach-Object { Write-Host "   - $($_.Name)" }
          } else {
            Write-Host "ERROR: Vite build did not create dist\renderer directory"
            Write-Host "Checking what was actually created in dist..."
            if (Test-Path "dist") {
              Get-ChildItem "dist" -Recurse
            } else {
              Write-Host "No dist directory exists at all"
            }
            exit 1
          }
          
          Write-Host "Building main process for Windows..."
          npm run build:main
          
          Write-Host "Building preload script for Windows..."  
          npm run build:preload
          
          # Verify no Mac artifacts in build
          Write-Host "Checking for any Mac artifacts in build..."
          $macArtifacts = Get-ChildItem "dist" -Recurse -Include "*.dylib", "*.framework", "*darwin*", "*macos*" -ErrorAction SilentlyContinue
          if ($macArtifacts.Count -gt 0) {
            Write-Host "ERROR: Mac artifacts found in build:"
            $macArtifacts | ForEach-Object { Write-Host "   $_" }
            exit 1
          } else {
            Write-Host "VERIFIED: No Mac artifacts found in build"
          }
          
          Write-Host "Application build completed (Windows-only)"
        shell: powershell
      
      - name: Verify Build Output
        run: |
          Write-Host "Verifying build output..."
          
          if (Test-Path "dist\main\index.js") {
            Write-Host "SUCCESS: Main process built: dist\main\index.js"
            $size = (Get-Item "dist\main\index.js").Length
            Write-Host "   Size: $size bytes"
          } else {
            Write-Host "ERROR: Main process missing: dist\main\index.js"
            if (Test-Path "dist") {
              Write-Host "Dist directory contents:"
              Get-ChildItem "dist" -Recurse
            }
            exit 1
          }
          
          if (Test-Path "dist\preload\index.js") {
            Write-Host "SUCCESS: Preload script built: dist\preload\index.js"
          } else {
            Write-Host "ERROR: Preload script missing: dist\preload\index.js"
            exit 1
          }
          
          if (Test-Path "dist\renderer") {
            Write-Host "SUCCESS: Renderer built: dist\renderer"
            $rendererFiles = Get-ChildItem "dist\renderer" -Recurse -File
            Write-Host "   Renderer files: $($rendererFiles.Count)"
          } else {
            Write-Host "ERROR: Renderer missing: dist\renderer"
            exit 1
          }
        shell: powershell
      
      - name: Generate Icons (Optional)
        run: |
          Write-Host "Generating application icons..."
          npm run icons
        continue-on-error: true
        shell: powershell
      
      - name: Package Windows Application
        run: |
          Write-Host "Packaging Windows application..."
          npm run make
          Write-Host "Windows packaging completed"
        shell: powershell
      
      - name: Test Application Startup
        run: |
          Write-Host "Testing application startup..."
          # Test that the built app can start without runtime errors
          $env:CI = "true"
          $env:NODE_ENV = "test"
          Write-Host "Testing main process imports..."
          node -e "
            try {
              console.log('Testing main process...');
              require('./dist/main/index.js');
              console.log('SUCCESS: Main process loads successfully');
            } catch (error) {
              if (error.message.includes('app.whenReady') || error.message.includes('electron')) {
                console.log('SUCCESS: Main process structure is valid (Electron context expected)');
              } else {
                console.error('ERROR: Main process error:', error.message);
                process.exit(1);
              }
            }
          "
          Write-Host "Testing database connectivity..."
          node -e "
            try {
              const Database = require('better-sqlite3');
              const db = new Database(':memory:');
              db.exec('CREATE TABLE test (id INTEGER)');
              db.exec('INSERT INTO test (id) VALUES (1)');
              const result = db.prepare('SELECT * FROM test').get();
              db.close();
              console.log('SUCCESS: Database operations work correctly');
            } catch (error) {
              console.error('ERROR: Database test failed:', error.message);
              process.exit(1);
            }
          "
          Write-Host "Application startup tests passed"
        shell: powershell
      
      - name: Verify Windows Installer
        run: |
          Write-Host "Verifying Windows installer..."
          
          if (Test-Path "out\make\squirrel.windows") {
            Write-Host "SUCCESS: Squirrel installer directory exists"
            $installers = Get-ChildItem "out\make\squirrel.windows" -Recurse -Include "*.exe"
            if ($installers.Count -gt 0) {
              Write-Host "SUCCESS: Windows installer(s) created:"
              foreach ($installer in $installers) {
                $size = $installer.Length / 1MB
                Write-Host "   $($installer.Name) ($([math]::Round($size, 2)) MB)"
              }
            } else {
              Write-Host "ERROR: No .exe installers found"
              Write-Host "Directory contents:"
              Get-ChildItem "out\make\squirrel.windows" -Recurse
              exit 1
            }
          } else {
            Write-Host "ERROR: Squirrel installer directory missing"
            if (Test-Path "out") {
              Write-Host "Out directory contents:"
              Get-ChildItem "out" -Recurse
            }
            exit 1
          }
        shell: powershell
      
      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: out/make/squirrel.windows/**/*.exe
          retention-days: 30
      
      - name: Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: out/make/squirrel.windows/**/*.exe
          name: "Isla Journal ${{ github.ref_name }}"
          draft: false
          prerelease: false
          generate_release_notes: true